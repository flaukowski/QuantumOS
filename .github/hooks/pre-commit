#!/bin/bash
#
# QuantumOS Pre-Commit Hook
#
# Validates contributions before they can be committed.
# Install with: ./scripts/install-hooks.sh
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Colors (may not work in all git environments)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "Running QuantumOS pre-commit checks..."

# Get list of staged files
STAGED_C=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|h)$' || true)

if [ -z "$STAGED_C" ]; then
    echo "No C/H files staged, skipping checks."
    exit 0
fi

ERRORS=0

# Check 1: Quick API consistency check on staged files
echo "[1/3] Checking API consistency..."
for file in $STAGED_C; do
    if [ -f "$file" ]; then
        # Check for known bad patterns
        if grep -q "ipc_create_queue\|ipc_destroy_queue" "$file" 2>/dev/null; then
            echo "ERROR: $file uses deprecated IPC API"
            echo "  Use ipc_process_init() / ipc_process_cleanup() instead"
            ((ERRORS++))
        fi
    fi
done

# Check 2: Compilation test (if make available)
echo "[2/3] Testing compilation..."
if command -v make &> /dev/null; then
    if ! make -q 2>/dev/null; then
        # Something needs rebuilding, try a build
        if ! make > /dev/null 2>&1; then
            echo "ERROR: Code does not compile"
            echo "  Run 'make' to see errors"
            ((ERRORS++))
        fi
    fi
else
    echo "  (make not available, skipping)"
fi

# Check 3: Basic file checks
echo "[3/3] Checking file quality..."
for file in $STAGED_C; do
    if [ -f "$file" ]; then
        # Check for trailing whitespace
        if grep -q "[[:space:]]$" "$file" 2>/dev/null; then
            echo "WARNING: $file has trailing whitespace"
        fi
    fi
done

if [ $ERRORS -gt 0 ]; then
    echo ""
    echo "Pre-commit check FAILED with $ERRORS error(s)"
    echo "Fix the errors and try again, or use --no-verify to skip."
    exit 1
fi

echo "Pre-commit checks passed!"
exit 0
